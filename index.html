<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watchlist Recommender</title>
  <style>
    /* Letterboxd Brand Palette & Global Styles */
    :root {
      --bg-deep: #14181c;
      --bg-panel: #1b2228;
      --bg-input: #2c3440;
      --text-muted: #9ab;
      --text-bright: #fff;
      --lb-green: #00e054;
      --lb-border: #456;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      margin: 0; 
      padding: 10px;
      line-height: 1.5; 
      color: var(--text-muted);
      background-color: var(--bg-deep);
    }

    .card { 
      background-color: var(--bg-panel);
      border-radius: 12px; 
      padding: 20px; 
      max-width: 900px; 
      margin: auto; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    h2 { color: var(--text-bright); margin-top: 0; border-bottom: 1px solid var(--lb-border); padding-bottom: 10px; }

    /* Forms & Controls */
    .row { 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
      align-items: flex-end; 
      margin-bottom: 20px; 
    }

    .row label { flex: 1; min-width: 200px; font-size: 11px; font-weight: bold; color: var(--text-bright); text-transform: uppercase; letter-spacing: 1px; }

    input, select, button { 
      font-size: 14px; 
      padding: 10px; 
      border-radius: 4px; 
      border: none; 
      background: var(--bg-input); 
      color: var(--text-bright); 
      width: 100%;
      box-sizing: border-box;
      margin-top: 5px;
    }

    button { 
      font-weight: bold; 
      text-transform: uppercase; 
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s ease;
      height: 42px;
    }

    button.primary { background: var(--lb-green); color: #000; }
    button.primary:hover { background: #00b044; transform: translateY(-1px); }
    button.secondary { background: #445566; color: var(--text-bright); }

    /* Navigation Tabs */
    .tabs { 
      display: flex; 
      gap: 5px; 
      margin: 20px 0; 
      overflow-x: auto; 
      padding-bottom: 5px;
      border-bottom: 1px solid var(--lb-border);
    }

    .tab { 
      padding: 8px 16px; 
      background: transparent; 
      border: none;
      border-radius: 4px 4px 0 0;
      white-space: nowrap; 
      font-size: 12px;
      color: var(--text-muted);
      width: auto;
    }

    .tab.active { background: var(--bg-input); color: var(--text-bright); box-shadow: inset 0 -2px 0 var(--lb-green); }

    /* Panels */
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; margin-top: 10px; }
    .panel { border: 1px solid var(--lb-border); border-radius: 8px; padding: 15px; background: rgba(255,255,255,0.02); }
    .panel b { color: var(--text-bright); display: block; margin-bottom: 5px; }

    /* Results Styling */
    .result { margin-top: 20px; padding-top: 20px; }
    .hero-pick { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
    .hero-poster { width: 160px; border-radius: 4px; border: 1px solid var(--lb-border); box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    .hero-content { flex: 1; min-width: 280px; }
    .hero-content h3 { margin: 0; color: var(--text-bright); font-size: 1.5rem; }
    .hero-content h3 span { color: var(--text-muted); font-weight: normal; }
    
    .pill { 
      background: var(--bg-input); 
      color: var(--text-muted); 
      padding: 3px 8px; 
      border-radius: 3px; 
      font-size: 11px; 
      margin: 10px 5px 10px 0;
      display: inline-block;
      border: 1px solid var(--lb-border);
    }

    .others-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
      gap: 15px; 
      margin-top: 15px; 
    }
    
    .other-card { 
      display: flex; 
      gap: 12px; 
      background: var(--bg-input); 
      padding: 10px; 
      border-radius: 6px; 
      border: 1px solid transparent;
      transition: border-color 0.2s;
    }
    .other-card:hover { border-color: var(--lb-green); }
    .other-card img { width: 50px; border-radius: 3px; }
    .other-info { font-size: 12px; overflow: hidden; }
    .other-title { color: var(--text-bright); font-weight: bold; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }

    .status { font-size: 13px; color: var(--lb-green); margin: 15px 0; min-height: 1.5em; }
    .danger { color: #ff6666; font-weight: bold; }
    a { color: var(--text-bright); text-decoration: none; border-bottom: 1px solid #567; padding-bottom: 1px; }
    a:hover { color: var(--lb-green); border-bottom-color: var(--lb-green); }

    /* Mobile Responsive Fixes */
    @media (max-width: 600px) {
      .hero-pick { flex-direction: column; align-items: center; text-align: center; }
      .row { flex-direction: column; align-items: stretch; }
      .row label { min-width: 100%; }
      .hero-content { min-width: 100%; }
    }
  </style>
</head>
<body>

  <div class="card">
    <h2>üçø Watchlist Recommender</h2>
    <p class="muted" style="font-size: 13px;">Upload your Letterboxd <span class="mono">watchlist.csv</span> to get started.</p>

    <div class="row">
      <label>TMDb API Key<input id="apiKey" type="password" placeholder="v3 api key" /></label>
      <label>Watchlist CSV<input type="file" id="csvFile" accept=".csv" /></label>
      <div style="display:flex; gap:10px; width:100%; max-width: 300px;">
        <button class="secondary" id="clearCache" style="flex:1;">Clear</button>
        <button class="primary" id="recommendBtn" style="flex:2;">Recommend</button>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="random">Random</button>
      <button class="tab" data-tab="genre">By Genre</button>
      <button class="tab" data-tab="similar_any">Similar (Global)</button>
      <button class="tab" data-tab="similar_watchlist">Similar (Watchlist)</button>
    </div>

    <div class="grid">
      <div class="panel" id="panel_random">
        <b>Random Discovery</b>
        <p class="muted" style="font-size:12px; margin:0;">Picks fresh titles directly from your uploaded watchlist.</p>
      </div>
      <div class="panel" id="panel_genre" style="display:none;">
        <b>Genre Filter</b>
        <select id="genreSelect"></select>
      </div>
      <div class="panel" id="panel_similar_any" style="display:none;">
        <input id="seedTitle" placeholder="Seed Movie (e.g. Dune)" style="margin-bottom:8px;"/>
        <input id="seedYear" placeholder="Year (optional)" inputmode="numeric"/>
      </div>
      <div class="panel" id="panel_similar_watchlist" style="display:none;">
        <input id="seedTitle2" placeholder="Seed Movie" style="margin-bottom:8px;"/>
        <input id="seedYear2" placeholder="Year (optional)" inputmode="numeric"/>
      </div>
    </div>

    <div class="status" id="status"></div>
    <div class="result" id="result" style="display:none;"></div>
  </div>

<script>
/***********************
 * STATE & CACHING
 ***********************/
const WATCHLIST_CACHE_KEY = "lb_watchlist_v4";
const TMDB_KEY_CACHE_KEY  = "tmdb_key_v3";
const GENRE_CACHE_KEY     = "tmdb_genres_v3";

let watchlist = [];
let genreMap = { idToName: {}, nameToId: {} };
let activeTab = "random";

const elApiKey = document.getElementById("apiKey");
const elCsvFile = document.getElementById("csvFile");
const elClearCache = document.getElementById("clearCache");
const elRecommendBtn = document.getElementById("recommendBtn");
const elStatus = document.getElementById("status");
const elResult = document.getElementById("result");
const elGenreSelect = document.getElementById("genreSelect");

const panels = {
  random: document.getElementById("panel_random"),
  genre: document.getElementById("panel_genre"),
  similar_any: document.getElementById("panel_similar_any"),
  similar_watchlist: document.getElementById("panel_similar_watchlist"),
};

/***********************
 * UTILS
 ***********************/
const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
const setStatus = (msg, isErr=false) => elStatus.innerHTML = isErr ? `<span class="danger">${msg}</span>` : msg;
const hideResult = () => { elResult.style.display="none"; elResult.innerHTML=""; };
const pickRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
const sleep = (ms) => new Promise(r => setTimeout(r, ms));
const normalizeTitle = (s) => String(s || "").toLowerCase().replace(/[‚Äô']/g, "").replace(/[^a-z0-9 ]/g, " ").replace(/\s+/g, " ").trim();

/***********************
 * API CORE
 ***********************/
async function tmdbGet(path, params = {}) {
  const key = elApiKey.value.trim() || localStorage.getItem(TMDB_KEY_CACHE_KEY);
  if (!key) throw new Error("API Key required.");
  const url = new URL(`https://api.themoviedb.org/3/${path}`);
  url.searchParams.set("api_key", key);
  Object.entries(params).forEach(([k,v]) => v && url.searchParams.set(k, v));
  const res = await fetch(url);
  if (!res.ok) throw new Error("API Error: " + res.status);
  return res.json();
}

async function loadGenreMap() {
  const cached = localStorage.getItem(GENRE_CACHE_KEY);
  if (cached) { genreMap = JSON.parse(cached); populateGenreSelect(); return; }
  const data = await tmdbGet("genre/movie/list");
  data.genres.forEach(g => { genreMap.idToName[g.id] = g.name; genreMap.nameToId[g.name.toLowerCase()] = g.id; });
  localStorage.setItem(GENRE_CACHE_KEY, JSON.stringify(genreMap));
  populateGenreSelect();
}

function populateGenreSelect() {
  const names = Object.values(genreMap.idToName).sort();
  elGenreSelect.innerHTML = names.map(n => `<option value="${genreMap.nameToId[n.toLowerCase()]}">${n}</option>`).join("");
}

/***********************
 * CSV LOGIC
 ***********************/
function parseCSV(text) {
  const rows = []; let row = []; let cur = ""; let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"' && text[i+1] === '"') { cur += '"'; i++; continue; }
    if (c === '"') { inQuotes = !inQuotes; continue; }
    if (!inQuotes && c === ",") { row.push(cur); cur = ""; continue; }
    if (!inQuotes && (c === "\n" || c === "\r")) {
      if (c === "\r" && text[i+1] === "\n") i++;
      row.push(cur); cur = "";
      if (row.some(x => x.trim())) rows.push(row);
      row = []; continue;
    }
    cur += c;
  }
  if (cur || row.length) { row.push(cur); if (row.some(x => x.trim())) rows.push(row); }
  return rows;
}

elCsvFile.addEventListener("change", async () => {
  try {
    const rows = parseCSV(await elCsvFile.files[0].text());
    const h = rows[0].map(x => x.trim().toLowerCase());
    const iN = h.indexOf("name"), iY = h.indexOf("year"), iU = h.findIndex(x => x.includes("uri"));
    watchlist = rows.slice(1).map(r => ({ titleGuess: r[iN], yearGuess: r[iY], lbUrl: r[iU] })).filter(x => x.titleGuess);
    localStorage.setItem(WATCHLIST_CACHE_KEY, JSON.stringify({ items: watchlist }));
    setStatus(`Imported ${watchlist.length} movies.`);
  } catch (e) { setStatus("CSV Import Failed", true); }
});

elClearCache.addEventListener("click", () => { localStorage.clear(); location.reload(); });

/***********************
 * DISPLAY & LOGIC
 ***********************/
function renderPick(tm, opts = {}) {
  const poster = tm.poster_path ? `https://image.tmdb.org/t/p/w500${tm.poster_path}` : "";
  const year = (tm.release_date || "").slice(0,4);
  const genres = (tm.genre_ids || []).map(id => genreMap.idToName[id]).filter(Boolean);

  let html = `
    <div class="result">
      ${opts.seed ? `<p style="font-size:12px; margin-bottom:15px;">Inspired by <b>${escapeHtml(opts.seed.title)}</b></p>` : ""}
      <div class="hero-pick">
        ${poster ? `<img src="${poster}" class="hero-poster">` : ""}
        <div class="hero-content">
          <h3>${escapeHtml(tm.title)} <span>(${year})</span></h3>
          <div>${genres.map(g => `<span class="pill">${escapeHtml(g)}</span>`).join("")}</div>
          <p style="color: var(--text-muted); font-size: 14px;">${escapeHtml(tm.overview || "No overview.")}</p>
          <div style="margin-top:15px; font-size:13px;">
            <a href="https://www.themoviedb.org/movie/${tm.id}" target="_blank">TMDb</a>
            ${opts.lbUrl ? ` &nbsp;‚Ä¢&nbsp; <a href="${opts.lbUrl}" target="_blank">Letterboxd</a>` : ""}
          </div>
        </div>
      </div>
  `;

  if (opts.others?.length) {
    html += `
      <div style="border-top: 1px solid var(--lb-border); padding-top: 20px;">
        <span style="font-size:11px; font-weight:bold; text-transform:uppercase;">More choices</span>
        <div class="others-grid">
    `;
    opts.others.forEach(m => {
      const p = m.tm.poster_path ? `https://image.tmdb.org/t/p/w200${m.tm.poster_path}` : "";
      html += `
        <div class="other-card">
          ${p ? `<img src="${p}">` : ""}
          <div class="other-info">
            <div class="other-title">${escapeHtml(m.tm.title)}</div>
            <div class="muted">${(m.tm.release_date||"").slice(0,4)}</div>
            <a href="https://www.themoviedb.org/movie/${m.tm.id}" target="_blank" style="font-size:10px; border:none;">Details</a>
          </div>
        </div>
      `;
    });
    html += `</div></div>`;
  }
  elResult.innerHTML = html + `</div>`;
  elResult.style.display = "block";
}

elRecommendBtn.addEventListener("click", async () => {
  const btnText = elRecommendBtn.textContent;
  try {
    elRecommendBtn.disabled = true; elRecommendBtn.textContent = "Searching...";
    hideResult();
    if (elApiKey.value) localStorage.setItem(TMDB_KEY_CACHE_KEY, elApiKey.value.trim());
    if (!Object.keys(genreMap.idToName).length) await loadGenreMap();

    if (activeTab === "random") {
      if (!watchlist.length) throw new Error("Upload watchlist.");
      const picks = Array.from({length:4}, () => pickRandom(watchlist));
      const results = await Promise.all(picks.map(p => tmdbGet("search/movie", { query: p.titleGuess, year: p.yearGuess })));
      const valid = results.map((r, i) => ({ tm: r.results[0], lbUrl: picks[i].lbUrl })).filter(v => v.tm);
      renderPick(valid[0].tm, { lbUrl: valid[0].lbUrl, others: valid.slice(1) });
    } 

    else if (activeTab === "genre") {
      const gid = Number(elGenreSelect.value);
      const shuffled = [...watchlist].sort(() => 0.5 - Math.random());
      const matches = [];
      for (let i = 0; i < shuffled.length && matches.length < 4; i++) {
        setStatus(`Searching... ${matches.length}/4 matches`);
        const s = await tmdbGet("search/movie", { query: shuffled[i].titleGuess, year: shuffled[i].yearGuess });
        if (s.results[0]?.genre_ids.includes(gid)) matches.push({ tm: s.results[0], lbUrl: shuffled[i].lbUrl });
        await sleep(150);
      }
      renderPick(matches[0].tm, { lbUrl: matches[0].lbUrl, others: matches.slice(1) });
    }

    else if (activeTab.startsWith("similar")) {
      const isW = activeTab === "similar_watchlist";
      const title = document.getElementById(isW ? "seedTitle2" : "seedTitle").value;
      const seedRes = await tmdbGet("search/movie", { query: title });
      const seed = seedRes.results[0];
      const simRes = await tmdbGet(`movie/${seed.id}/similar`);
      if (isW) {
        const wlMap = new Map(watchlist.map(w => [normalizeTitle(w.titleGuess), w]));
        const matches = simRes.results.filter(s => wlMap.has(normalizeTitle(s.title))).map(s => ({ tm: s, lbUrl: wlMap.get(normalizeTitle(s.title)).lbUrl }));
        renderPick(matches[0].tm, { seed, lbUrl: matches[0].lbUrl, others: matches.slice(1, 4) });
      } else {
        const list = simRes.results.slice(0, 4).map(s => ({ tm: s }));
        renderPick(list[0].tm, { seed, others: list.slice(1) });
      }
    }
    setStatus("Done.");
  } catch (e) { setStatus(e.message, true); }
  finally { elRecommendBtn.disabled = false; elRecommendBtn.textContent = btnText; }
});

document.getElementById("tabs").addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-tab]");
  if (!btn) return;
  activeTab = btn.dataset.tab;
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  btn.classList.add("active");
  Object.entries(panels).forEach(([k, el]) => el.style.display = (k === activeTab) ? "block" : "none");
});

(function init() {
  const k = localStorage.getItem(TMDB_KEY_CACHE_KEY); if (k) elApiKey.value = k;
  const raw = localStorage.getItem(WATCHLIST_CACHE_KEY);
  if (raw) { watchlist = JSON.parse(raw).items; setStatus(`Ready: ${watchlist.length} movies cached.`); }
  if (k) loadGenreMap();
})();
</script>
</body>
</html>
