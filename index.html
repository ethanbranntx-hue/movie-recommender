<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watchlist Recommender</title>
  <style>
    body { font-family: -apple-system, system-ui, Arial; margin: 18px; line-height: 1.35; color: #111; }
    .card { border: 1px solid #ddd; border-radius: 16px; padding: 20px; max-width: 900px; margin: auto; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; margin-bottom: 15px; }
    input, select, button { font-size: 16px; padding: 10px 12px; border-radius: 12px; border: 1px solid #ccc; }
    button { border: 0; cursor: pointer; transition: opacity 0.2s; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.primary { background: #111; color: #fff; }
    button.secondary { background: #eee; color: #111; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin: 20px 0 10px; }
    .tab { padding: 8px 14px; border-radius: 999px; border: 1px solid #ccc; background:#fff; cursor:pointer; }
    .tab.active { background:#111; color:#fff; border-color:#111; }
    small { color: #555; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 0.9em; background: #f4f4f4; padding: 2px 4px; border-radius: 4px; }
    .status { margin-top: 15px; min-height: 1.5em; font-size: 14px; }
    .result { margin-top: 14px; padding-top: 20px; border-top: 1px dashed #ddd; }
    a { color: #0b57d0; text-decoration: none; font-weight: 500; }
    a:hover { text-decoration: underline; }
    .muted { color:#666; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr; margin-top: 10px; }
    @media (min-width: 740px) { .grid { grid-template-columns: 1fr 1fr; } }
    .panel { border:1px solid #e5e5e5; border-radius:14px; padding:15px; background: #fafafa; }
    .danger { color:#b00020; font-weight: bold; }
    .pill { display:inline-block; padding: 4px 12px; border-radius: 999px; border: 1px solid #ddd; margin: 4px 6px 0 0; font-size: 12px; background: #fff; }
    .hint { font-size: 13px; margin-top: 10px; }
  </style>
</head>
<body>

  <div class="card">
    <h2>üçø Watchlist Recommender</h2>
    <p class="muted">
      Upload your <span class="mono">watchlist.csv</span> from a Letterboxd export. It saves locally to your browser.
    </p>

    <div class="row">
      <label>
        TMDb API Key (v3)<br/>
        <input id="apiKey" type="password" placeholder="paste key here" />
      </label>

      <label>
        Upload watchlist.csv<br/>
        <input type="file" id="csvFile" accept=".csv" />
      </label>

      <button class="secondary" id="clearCache">Clear Cache</button>
      <button class="primary" id="recommendBtn">Recommend</button>
    </div>

    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="random">Random</button>
      <button class="tab" data-tab="genre">By Genre</button>
      <button class="tab" data-tab="similar_any">Similar (Any)</button>
      <button class="tab" data-tab="similar_watchlist">Similar (Watchlist)</button>
    </div>

    <div class="grid">
      <div class="panel" id="panel_random">
        <b>Random Pick</b>
        <p class="muted">Picks a completely random film from your watchlist.</p>
      </div>

      <div class="panel" id="panel_genre" style="display:none;">
        <b>Filter by Genre</b>
        <p class="muted">Samples your list to find a specific genre match.</p>
        <label>Genre<br/><select id="genreSelect" style="width:100%"></select></label>
        <p class="hint muted">Tip: if it can‚Äôt find a match, click Recommend again (it re-samples).</p>
      </div>

      <div class="panel" id="panel_similar_any" style="display:none;">
        <b>Similar to... (Global)</b>
        <p class="muted">Finds a movie similar to your "seed" from all of TMDb.</p>
        <input id="seedTitle" placeholder="Movie title (e.g. Inception)" style="width:100%; margin-bottom:8px;"/>
        <input id="seedYear" placeholder="Year (optional)" inputmode="numeric" style="width:100%"/>
      </div>

      <div class="panel" id="panel_similar_watchlist" style="display:none;">
        <b>Similar to... (Watchlist)</b>
        <p class="muted">Finds a movie similar to your "seed" that is <b>already</b> on your watchlist.</p>
        <input id="seedTitle2" placeholder="Movie title" style="width:100%; margin-bottom:8px;"/>
        <input id="seedYear2" placeholder="Year (optional)" inputmode="numeric" style="width:100%"/>
      </div>
    </div>

    <div class="status" id="status"></div>
    <div class="result" id="result" style="display:none;"></div>
  </div>

<script>
/***********************
 * STATE & CONSTANTS
 ***********************/
const WATCHLIST_CACHE_KEY = "lb_watchlist_csv_cache_v4";
const TMDB_KEY_CACHE_KEY  = "tmdb_key_cache_v3";
const GENRE_CACHE_KEY     = "tmdb_genres_cache_v3";

let watchlist = [];
let genreMap = { idToName: {}, nameToId: {} };
let activeTab = "random";

/***********************
 * DOM
 ***********************/
const elApiKey = document.getElementById("apiKey");
const elCsvFile = document.getElementById("csvFile");
const elClearCache = document.getElementById("clearCache");
const elRecommendBtn = document.getElementById("recommendBtn");
const elStatus = document.getElementById("status");
const elResult = document.getElementById("result");
const elGenreSelect = document.getElementById("genreSelect");

const panels = {
  random: document.getElementById("panel_random"),
  genre: document.getElementById("panel_genre"),
  similar_any: document.getElementById("panel_similar_any"),
  similar_watchlist: document.getElementById("panel_similar_watchlist"),
};

/***********************
 * UTILS
 ***********************/
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function setStatus(msg, isError=false) {
  const safe = escapeHtml(msg);
  elStatus.innerHTML = isError ? `<span class="danger">${safe}</span>` : safe;
}

function showResult(html) {
  elResult.style.display = "block";
  elResult.innerHTML = html;
}

function hideResult() {
  elResult.style.display = "none";
  elResult.innerHTML = "";
}

function pickRandom(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

function normalizeTitle(s) {
  return String(s || "").toLowerCase()
    .replace(/[‚Äô']/g, "")
    .replace(/&/g, " and ")
    .replace(/[^a-z0-9 ]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function ensureWatchlistLoaded() {
  if (!Array.isArray(watchlist) || watchlist.length === 0) {
    throw new Error("Upload watchlist.csv first.");
  }
}

/***********************
 * TMDb API
 ***********************/
function getTmdbKey() {
  const typed = elApiKey.value.trim();
  if (typed) return typed;

  const cached = (localStorage.getItem(TMDB_KEY_CACHE_KEY) || "").trim();
  if (cached) return cached;

  return "";
}

function requireTmdbKey() {
  const k = getTmdbKey();
  if (!k) throw new Error("Please enter a TMDb API Key.");
  return k;
}

async function tmdbGet(path, params = {}) {
  const key = requireTmdbKey();

  const url = new URL(`https://api.themoviedb.org/3/${path}`);
  url.searchParams.set("api_key", key);

  for (const [k, v] of Object.entries(params)) {
    if (v !== undefined && v !== null && String(v).trim() !== "") {
      url.searchParams.set(k, v);
    }
  }

  const res = await fetch(url.toString());
  if (!res.ok) {
    let txt = "";
    try { txt = await res.text(); } catch {}
    throw new Error(`TMDb API Error: ${res.status}${txt ? ` (${txt.slice(0, 120)})` : ""}`);
  }
  return res.json();
}

async function tmdbSearchMovie(title, yearOptional) {
  const data = await tmdbGet("search/movie", {
    query: title,
    year: yearOptional || undefined,
    include_adult: "false",
    language: "en-US"
  });
  const best = data.results?.[0];
  if (!best) throw new Error(`No TMDb result for "${title}". Try adding the year.`);
  return best;
}

async function tmdbSimilar(movieId) {
  const data = await tmdbGet(`movie/${movieId}/similar`, {
    language: "en-US",
    page: 1
  });
  return data.results || [];
}

/***********************
 * GENRES (cache-first)
 ***********************/
async function loadGenreMap() {
  // cache-first
  const cached = localStorage.getItem(GENRE_CACHE_KEY);
  if (cached) {
    try {
      const parsed = JSON.parse(cached);
      if (parsed?.idToName && parsed?.nameToId) {
        genreMap = parsed;
        populateGenreSelect();
        return;
      }
    } catch {}
  }

  setStatus("Loading TMDb genres‚Ä¶");
  const data = await tmdbGet("genre/movie/list", { language: "en-US" });

  const idToName = {};
  const nameToId = {};
  (data.genres || []).forEach(g => {
    idToName[g.id] = g.name;
    nameToId[String(g.name).toLowerCase()] = g.id;
  });

  genreMap = { idToName, nameToId };
  localStorage.setItem(GENRE_CACHE_KEY, JSON.stringify(genreMap));
  populateGenreSelect();
}

function populateGenreSelect() {
  const names = Object.values(genreMap.idToName)
    .sort((a,b) => a.localeCompare(b));

  elGenreSelect.innerHTML = names.map(name => {
    const id = genreMap.nameToId[String(name).toLowerCase()];
    return `<option value="${id}">${escapeHtml(name)}</option>`;
  }).join("");
}

/***********************
 * CSV PARSING
 ***********************/
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const next = text[i+1];

    if (c === '"' && next === '"') { cur += '"'; i++; continue; }
    if (c === '"') { inQuotes = !inQuotes; continue; }

    if (!inQuotes && c === ",") { row.push(cur); cur = ""; continue; }

    if (!inQuotes && (c === "\n" || c === "\r")) {
      if (c === "\r" && next === "\n") i++;
      row.push(cur); cur = "";
      if (row.some(cell => String(cell).trim() !== "")) rows.push(row);
      row = [];
      continue;
    }

    cur += c;
  }

  if (cur.length || row.length) {
    row.push(cur);
    if (row.some(cell => String(cell).trim() !== "")) rows.push(row);
  }

  return rows;
}

function watchlistFromCSV(csvText) {
  const rows = parseCSV(csvText);
  if (rows.length < 2) throw new Error("CSV looks empty.");

  const headers = rows[0].map(h => String(h).trim().toLowerCase());
  const idxName = headers.indexOf("name");
  const idxYear = headers.indexOf("year");
  const idxUri  = headers.findIndex(h => h.includes("letterboxd uri") || (h.includes("uri") && h.includes("letterboxd")));

  if (idxName === -1) throw new Error("Couldn‚Äôt find a 'Name' column. Make sure you uploaded Letterboxd watchlist.csv.");

  const items = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i] || [];
    const name = String(r[idxName] || "").trim();
    if (!name) continue;

    const year = idxYear !== -1 ? String(r[idxYear] || "").trim() : "";
    const lbUrl = idxUri !== -1 ? String(r[idxUri] || "").trim() : "";

    items.push({
      titleGuess: name,
      yearGuess: year,
      lbUrl: lbUrl || null
    });
  }

  if (!items.length) throw new Error("No movies parsed from CSV.");
  return items;
}

/***********************
 * EVENTS: CSV & CACHE
 ***********************/
elCsvFile.addEventListener("change", async () => {
  try {
    const file = elCsvFile.files?.[0];
    if (!file) return;

    setStatus("Reading CSV‚Ä¶");
    const text = await file.text();
    watchlist = watchlistFromCSV(text);

    localStorage.setItem(WATCHLIST_CACHE_KEY, JSON.stringify({
      savedAt: Date.now(),
      items: watchlist
    }));

    setStatus(`Loaded ${watchlist.length} movies from watchlist.csv.`);
    hideResult();
  } catch (e) {
    setStatus(e.message || "Error parsing CSV.", true);
  }
});

elClearCache.addEventListener("click", () => {
  localStorage.removeItem(WATCHLIST_CACHE_KEY);
  localStorage.removeItem(GENRE_CACHE_KEY);
  // keep TMDb key so you don't have to retype it:
  // localStorage.removeItem(TMDB_KEY_CACHE_KEY);

  watchlist = [];
  genreMap = { idToName: {}, nameToId: {} };
  elGenreSelect.innerHTML = "";
  hideResult();
  setStatus("Cache cleared. Upload watchlist.csv again.");
});

/***********************
 * RENDER RESULT
 ***********************/
function renderPick(tm, opts = {}) {
  const poster = tm.poster_path ? `https://image.tmdb.org/t/p/w500${tm.poster_path}` : "";
  const year = (tm.release_date || "").slice(0,4);
  const genres = (tm.genre_ids || []).map(id => genreMap.idToName[id]).filter(Boolean);

  showResult(`
    ${opts.seed ? `<p class="muted"><small>Because you liked: <b>${escapeHtml(opts.seed.title)}</b> ${opts.seed.release_date ? `(${escapeHtml((opts.seed.release_date||"").slice(0,4))})` : ""}</small></p>` : ""}
    <div style="display:flex; gap:15px; flex-wrap:wrap;">
      ${poster ? `<img src="${poster}" alt="" style="width:140px; border-radius:12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">` : ""}
      <div style="flex:1; min-width:260px;">
        <h3 style="margin:0;">${escapeHtml(tm.title || "Untitled")} ${year ? `<span class="muted">(${escapeHtml(year)})</span>` : ""}</h3>
        ${genres.length ? `<div style="margin:10px 0;">${genres.map(g => `<span class="pill">${escapeHtml(g)}</span>`).join("")}</div>` : ""}
        <p style="font-size:14px; color:#444;">${escapeHtml(tm.overview || "No overview available.")}</p>
        <a href="https://www.themoviedb.org/movie/${tm.id}" target="_blank" rel="noopener">View on TMDb</a>
        ${opts.lbUrl ? ` | <a href="${opts.lbUrl}" target="_blank" rel="noopener">View on Letterboxd</a>` : ""}
      </div>
    </div>
  `);
}

/***********************
 * TAB SWITCHING
 ***********************/
document.getElementById("tabs").addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-tab]");
  if (!btn) return;

  activeTab = btn.dataset.tab;

  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  btn.classList.add("active");

  Object.entries(panels).forEach(([k, el]) => {
    el.style.display = (k === activeTab) ? "block" : "none";
  });

  hideResult();
  setStatus("");
});

/***********************
 * RECOMMEND BUTTON
 ***********************/
elRecommendBtn.addEventListener("click", async () => {
  const originalText = elRecommendBtn.textContent;

  try {
    elRecommendBtn.disabled = true;
    elRecommendBtn.textContent = "Searching‚Ä¶";
    hideResult();

    // Save key if user typed it
    const typedKey = elApiKey.value.trim();
    if (typedKey) localStorage.setItem(TMDB_KEY_CACHE_KEY, typedKey);

    requireTmdbKey();

    // ensure genres available for pills
    if (!Object.keys(genreMap.idToName).length) await loadGenreMap();

    if (activeTab === "random") {
      ensureWatchlistLoaded();
      setStatus("Picking random from your watchlist‚Ä¶");
      const pick = pickRandom(watchlist);
      const tm = await tmdbSearchMovie(pick.titleGuess, pick.yearGuess);
      renderPick(tm, { lbUrl: pick.lbUrl });
      setStatus("Done.");
      return;
    }

    if (activeTab === "genre") {
      ensureWatchlistLoaded();
      const gid = Number(elGenreSelect.value);
      const gName = genreMap.idToName[gid] || "that genre";

      const shuffled = [...watchlist].sort(() => 0.5 - Math.random());
      const limit = Math.min(50, shuffled.length);

      for (let i = 0; i < limit; i++) {
        const item = shuffled[i];
        setStatus(`Scanning (${i+1}/${limit}): ${item.titleGuess}‚Ä¶`);

        try {
          const s = await tmdbSearchMovie(item.titleGuess, item.yearGuess);
          if ((s.genre_ids || []).includes(gid)) {
            renderPick(s, { lbUrl: item.lbUrl });
            setStatus(`Match found (${gName}).`);
            return;
          }
        } catch {
          // ignore mismatches
        }

        await sleep(140);
      }

      throw new Error(`No ${gName} match found in this sample. Click Recommend again to try a new sample.`);
    }

    if (activeTab === "similar_any" || activeTab === "similar_watchlist") {
      const isWatchlist = activeTab === "similar_watchlist";

      const title = (document.getElementById(isWatchlist ? "seedTitle2" : "seedTitle").value || "").trim();
      const year  = (document.getElementById(isWatchlist ? "seedYear2"  : "seedYear").value  || "").trim();

      if (!title) throw new Error("Enter a seed movie title.");

      setStatus("Searching seed movie‚Ä¶");
      const seed = await tmdbSearchMovie(title, year);

      setStatus(`Getting similar movies to "${seed.title}"‚Ä¶`);
      const similars = await tmdbSimilar(seed.id);
      if (!similars.length) throw new Error("TMDb returned no similar movies for that title.");

      if (!isWatchlist) {
        renderPick(pickRandom(similars), { seed });
        setStatus("Done.");
        return;
      }

      ensureWatchlistLoaded();

      const wlMap = new Map(watchlist.map(w => [normalizeTitle(w.titleGuess), w]));
      const matches = similars.filter(s => wlMap.has(normalizeTitle(s.title)));

      if (!matches.length) throw new Error("No similar movies found on your watchlist. Try a different seed title.");

      const pick = pickRandom(matches);
      const wl = wlMap.get(normalizeTitle(pick.title));
      renderPick(pick, { seed, lbUrl: wl?.lbUrl || null });
      setStatus("Done.");
      return;
    }

    setStatus("Done.");
  } catch (e) {
    setStatus(e?.message || "Something went wrong.", true);
  } finally {
    elRecommendBtn.disabled = false;
    elRecommendBtn.textContent = originalText;
  }
});

/***********************
 * INIT
 ***********************/
(function init() {
  try {
    const cachedKey = localStorage.getItem(TMDB_KEY_CACHE_KEY);
    if (cachedKey && !elApiKey.value) elApiKey.value = cachedKey;

    const raw = localStorage.getItem(WATCHLIST_CACHE_KEY);
    if (raw) {
      const data = JSON.parse(raw);
      if (Array.isArray(data?.items) && data.items.length) {
        watchlist = data.items;
        setStatus(`Ready: ${watchlist.length} watchlist movies cached. Paste TMDb key (if needed) and hit Recommend.`);
      } else {
        setStatus("Upload watchlist.csv, paste your TMDb key, then hit Recommend.");
      }
    } else {
      setStatus("Upload watchlist.csv, paste your TMDb key, then hit Recommend.");
    }

    // If key exists, pre-load genres
    if (getTmdbKey()) loadGenreMap().catch(()=>{});
  } catch {
    setStatus("Upload watchlist.csv, paste your TMDb key, then hit Recommend.");
  }
})();
</script>
</body>
</html>
